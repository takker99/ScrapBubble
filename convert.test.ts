import { convert } from "./convert.ts";
import { assertSnapshot } from "./deps/testing.ts";

Deno.test("convert", async (t) => {
  await t.step("one project", async (t) => {
    await t.step(
      "逆・順・双方向・空リンク+中身あり・空headword+複数パス2 hop links",
      async (t) => {
        await assertSnapshot(
          t,
          convert(
            "takker-dist",
            {
              "id": "63ab57239db1b2001edc43b0",
              "title": "B",
              "image": null,
              "descriptions": [
                "[B1], [B2], [B3]",
                "[A1]",
                "https://scrapbox.io/api/pages/takker-dist/B",
              ],
              "user": {
                "id": "5ef2bdebb60650001e1280f0",
                "name": "takker",
                "displayName": "takker",
                "photo":
                  "https://lh3.googleusercontent.com/a/ACg8ocLv_KexS5Z9P_dx2koMUeJeC4ThWjtwMiEHDizmuY7s3jf4j_c=s96-c",
              },
              "lastUpdateUser": {
                "id": "5ef2bdebb60650001e1280f0",
                "name": "takker",
                "displayName": "takker",
                "photo":
                  "https://lh3.googleusercontent.com/a/ACg8ocLv_KexS5Z9P_dx2koMUeJeC4ThWjtwMiEHDizmuY7s3jf4j_c=s96-c",
              },
              "pin": 0,
              "views": 20,
              "linked": 2,
              "commitId": "63b93444aded4c001e09d134",
              "created": 1672173349,
              "updated": 1673081924,
              "accessed": 1759205387,
              "snapshotCreated": 1673081924,
              "snapshotCount": 1,
              "pageRank": 7.6,
              "lastAccessed": 1759205394,
              "linesCount": 5,
              "charsCount": 64,
              "helpfeels": [],
              "persistent": true,
              "lines": [{
                "id": "63ab57239db1b2001edc43b0",
                "text": "B",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173349,
                "updated": 1672173349,
              }, {
                "id": "63ab57261280f000002d941d",
                "text": "[B1], [B2], [B3]",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173349,
                "updated": 1672173361,
              }, {
                "id": "63ab575f1280f000002d941f",
                "text": "[A1]",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173407,
                "updated": 1672173410,
              }, {
                "id": "63ab57271280f000002d941e",
                "text": "https://scrapbox.io/api/pages/takker-dist/B",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173351,
                "updated": 1673081924,
              }, {
                "id": "63b934441280f00000606f45",
                "text": "",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1673081924,
                "updated": 1673081924,
              }],
              "links": ["B1", "B2", "B3", "A1"],
              "projectLinks": [],
              "icons": [],
              "files": [],
              "infoboxDefinition": [],
              "infoboxResult": [],
              "infoboxDisableLinks": [],
              "relatedPages": {
                "links1hop": [{
                  "id": "63c0afb552e241001d99bfac",
                  "title": "I",
                  "titleLc": "i",
                  "image": null,
                  "descriptions": [
                    "[B] [B1] [K]",
                    "https://scrapbox.io/api/pages/takker-dist/I",
                  ],
                  "linksLc": ["b", "b1", "k"],
                  "linked": 2,
                  "pageRank": 5,
                  "created": 1673572279,
                  "updated": 1673572411,
                  "accessed": 1757069632,
                  "charsCount": 56,
                  "lastAccessed": 1734060339,
                }, {
                  "id": "63b933f82895b8001d9f5cd1",
                  "title": "B1",
                  "titleLc": "b1",
                  "image": null,
                  "descriptions": ["[B]"],
                  "linksLc": ["b"],
                  "linked": 7,
                  "pageRank": 8,
                  "created": 1673081850,
                  "updated": 1673081852,
                  "accessed": 1753902714,
                  "charsCount": 5,
                  "lastAccessed": 1734060423,
                }],
                "links2hop": [{
                  "id": "63ab5703d28d9b001d611a14",
                  "title": "A",
                  "titleLc": "a",
                  "image":
                    "https://i.kakeru.app/9616a5d5938df1d726b8a2e07ebbf581.svg",
                  "descriptions": [
                    "[A1],[A2],[A3]",
                    "https://scrapbox.io/api/pages/takker-dist/A",
                    "[https://kakeru.app/9616a5d5938df1d726b8a2e07ebbf581 https://i.kakeru.app/9616a5d5938df1d726b8a2e07ebbf581.svg]",
                  ],
                  "linksLc": ["a1", "a2", "a3"],
                  "linked": 0,
                  "pageRank": 3.4,
                  "created": 1672173317,
                  "updated": 1734060505,
                  "accessed": 1754956176,
                  "charsCount": 169,
                  "lastAccessed": 1734063246,
                }, {
                  "id": "63c0b022d59376001dc1d28c",
                  "title": "K",
                  "titleLc": "k",
                  "image": null,
                  "descriptions": ["[I] [B1]"],
                  "linksLc": ["i", "b1"],
                  "linked": 1,
                  "pageRank": 3,
                  "created": 1673572387,
                  "updated": 1673572392,
                  "accessed": 1754807109,
                  "charsCount": 9,
                  "lastAccessed": 1734060440,
                }, {
                  "id": "63c0affc1d7546001dfa9f9a",
                  "title": "J",
                  "titleLc": "j",
                  "image": null,
                  "descriptions": ["[I] [B1]"],
                  "linksLc": ["i", "b1"],
                  "linked": 0,
                  "pageRank": 2,
                  "created": 1673572350,
                  "updated": 1673572354,
                  "accessed": 1758212397,
                  "charsCount": 9,
                  "lastAccessed": 1734060457,
                }, {
                  "id": "63b9343133a85a001ea1d3c3",
                  "title": "E",
                  "titleLc": "e",
                  "image": null,
                  "descriptions": ["[B1], [B2]"],
                  "linksLc": ["b1", "b2"],
                  "linked": 0,
                  "pageRank": 2,
                  "created": 1673081906,
                  "updated": 1673081909,
                  "accessed": 1758279658,
                  "charsCount": 11,
                  "lastAccessed": 1734060472,
                }, {
                  "id": "63b93413cb7e16001e1143af",
                  "title": "D",
                  "titleLc": "d",
                  "image": null,
                  "descriptions": ["[B1]"],
                  "linksLc": ["b1"],
                  "linked": 0,
                  "pageRank": 1,
                  "created": 1673081876,
                  "updated": 1673081879,
                  "accessed": 1755885345,
                  "charsCount": 5,
                  "lastAccessed": 1734060467,
                }, {
                  "id": "63ab57bd101f5f001ee7125c",
                  "title": "C",
                  "titleLc": "c",
                  "image": null,
                  "descriptions": ["[C1], [C2], [C3]", "[A2], [A3]", "[B1]"],
                  "linksLc": ["c1", "c2", "c3", "a2", "a3", "b1"],
                  "linked": 0,
                  "pageRank": 6.2,
                  "created": 1672173504,
                  "updated": 1673081866,
                  "accessed": 1754397091,
                  "charsCount": 31,
                  "lastAccessed": 1734060326,
                }],
                "fatHeadwordsLc": [],
                "hiddenHeadwordsLc": [],
                "projectLinks1hop": [],
                "hasBackLinksOrIcons": true,
                "search": "",
                "charsCount": { "links1hop": 61, "links2hop": 234 },
                "searchBackend": "elasticsearch",
              },
              "collaborators": [],
            },
          ),
        );
      },
    );

    await t.step(
      "(逆リンク|順リンク|双方向リンク)+2 hop links",
      async (t) => {
        await assertSnapshot(
          t,
          convert("takker-dist", {
            "id": "63ab57239db1b2001edc43b0",
            "title": "B",
            "image": null,
            "descriptions": [
              "[B1], [B2], [B3]",
              "[A1]",
              "https://scrapbox.io/api/pages/takker-dist/B",
            ],
            "user": {
              "id": "5ef2bdebb60650001e1280f0",
              "name": "takker",
              "displayName": "takker",
              "photo":
                "https://lh3.googleusercontent.com/a/ACg8ocLv_KexS5Z9P_dx2koMUeJeC4ThWjtwMiEHDizmuY7s3jf4j_c=s96-c",
            },
            "lastUpdateUser": {
              "id": "5ef2bdebb60650001e1280f0",
              "name": "takker",
              "displayName": "takker",
              "photo":
                "https://lh3.googleusercontent.com/a/ACg8ocLv_KexS5Z9P_dx2koMUeJeC4ThWjtwMiEHDizmuY7s3jf4j_c=s96-c",
            },
            "pin": 0,
            "views": 21,
            "linked": 2,
            "commitId": "68db582ba07e75f1c4478b8c",
            "created": 1672173349,
            "updated": 1759205419,
            "accessed": 1759205417,
            "snapshotCreated": 1759205419,
            "snapshotCount": 2,
            "pageRank": 7.6,
            "lastAccessed": 1759205425,
            "linesCount": 5,
            "charsCount": 64,
            "helpfeels": [],
            "persistent": true,
            "lines": [
              {
                "id": "63ab57239db1b2001edc43b0",
                "text": "B",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173349,
                "updated": 1672173349,
              },
              {
                "id": "63ab57261280f000002d941d",
                "text": "[B1], [B2], [B3]",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173349,
                "updated": 1672173361,
              },
              {
                "id": "63ab575f1280f000002d941f",
                "text": "[A1]",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173407,
                "updated": 1672173410,
              },
              {
                "id": "63ab57271280f000002d941e",
                "text": "https://scrapbox.io/api/pages/takker-dist/B",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1672173351,
                "updated": 1673081924,
              },
              {
                "id": "68db582c00000000001dd307",
                "text": "",
                "userId": "5ef2bdebb60650001e1280f0",
                "created": 1759205419,
                "updated": 1759205419,
              },
            ],
            "links": [
              "B1",
              "B2",
              "B3",
              "A1",
            ],
            "projectLinks": [],
            "icons": [],
            "files": [],
            "infoboxDefinition": [],
            "infoboxResult": [],
            "infoboxDisableLinks": [],
            "relatedPages": {
              "links1hop": [
                {
                  "id": "63c0afb552e241001d99bfac",
                  "title": "I",
                  "titleLc": "i",
                  "image": null,
                  "descriptions": [
                    "[B] [B1] [K]",
                    "https://scrapbox.io/api/pages/takker-dist/I",
                  ],
                  "linksLc": [
                    "b",
                    "b1",
                    "k",
                  ],
                  "linked": 2,
                  "pageRank": 5,
                  "created": 1673572279,
                  "updated": 1673572411,
                  "accessed": 1757069632,
                  "charsCount": 56,
                  "lastAccessed": 1734060339,
                },
                {
                  "id": "63b933f82895b8001d9f5cd1",
                  "title": "B1",
                  "titleLc": "b1",
                  "image": null,
                  "descriptions": [
                    "[B]",
                  ],
                  "linksLc": [
                    "b",
                  ],
                  "linked": 7,
                  "pageRank": 8,
                  "created": 1673081850,
                  "updated": 1673081852,
                  "accessed": 1753902714,
                  "charsCount": 5,
                  "lastAccessed": 1734060423,
                },
              ],
              "links2hop": [
                {
                  "id": "63ab5703d28d9b001d611a14",
                  "title": "A",
                  "titleLc": "a",
                  "image":
                    "https://i.kakeru.app/9616a5d5938df1d726b8a2e07ebbf581.svg",
                  "descriptions": [
                    "[A1],[A2],[A3]",
                    "https://scrapbox.io/api/pages/takker-dist/A",
                    "[https://kakeru.app/9616a5d5938df1d726b8a2e07ebbf581 https://i.kakeru.app/9616a5d5938df1d726b8a2e07ebbf581.svg]",
                  ],
                  "linksLc": [
                    "a1",
                    "a2",
                    "a3",
                  ],
                  "linked": 0,
                  "pageRank": 3.4,
                  "created": 1672173317,
                  "updated": 1734060505,
                  "accessed": 1754956176,
                  "charsCount": 169,
                  "lastAccessed": 1734063246,
                },
                {
                  "id": "63c0b022d59376001dc1d28c",
                  "title": "K",
                  "titleLc": "k",
                  "image": null,
                  "descriptions": [
                    "[I] [B1]",
                  ],
                  "linksLc": [
                    "i",
                    "b1",
                  ],
                  "linked": 1,
                  "pageRank": 3,
                  "created": 1673572387,
                  "updated": 1673572392,
                  "accessed": 1754807109,
                  "charsCount": 9,
                  "lastAccessed": 1734060440,
                },
                {
                  "id": "63c0affc1d7546001dfa9f9a",
                  "title": "J",
                  "titleLc": "j",
                  "image": null,
                  "descriptions": [
                    "[I] [B1]",
                  ],
                  "linksLc": [
                    "i",
                    "b1",
                  ],
                  "linked": 0,
                  "pageRank": 2,
                  "created": 1673572350,
                  "updated": 1673572354,
                  "accessed": 1758212397,
                  "charsCount": 9,
                  "lastAccessed": 1734060457,
                },
                {
                  "id": "63b9343133a85a001ea1d3c3",
                  "title": "E",
                  "titleLc": "e",
                  "image": null,
                  "descriptions": [
                    "[B1], [B2]",
                  ],
                  "linksLc": [
                    "b1",
                    "b2",
                  ],
                  "linked": 0,
                  "pageRank": 2,
                  "created": 1673081906,
                  "updated": 1673081909,
                  "accessed": 1758279658,
                  "charsCount": 11,
                  "lastAccessed": 1734060472,
                },
                {
                  "id": "63b93413cb7e16001e1143af",
                  "title": "D",
                  "titleLc": "d",
                  "image": null,
                  "descriptions": [
                    "[B1]",
                  ],
                  "linksLc": [
                    "b1",
                  ],
                  "linked": 0,
                  "pageRank": 1,
                  "created": 1673081876,
                  "updated": 1673081879,
                  "accessed": 1755885345,
                  "charsCount": 5,
                  "lastAccessed": 1734060467,
                },
                {
                  "id": "63ab57bd101f5f001ee7125c",
                  "title": "C",
                  "titleLc": "c",
                  "image": null,
                  "descriptions": [
                    "[C1], [C2], [C3]",
                    "[A2], [A3]",
                    "[B1]",
                  ],
                  "linksLc": [
                    "c1",
                    "c2",
                    "c3",
                    "a2",
                    "a3",
                    "b1",
                  ],
                  "linked": 0,
                  "pageRank": 6.2,
                  "created": 1672173504,
                  "updated": 1673081866,
                  "accessed": 1754397091,
                  "charsCount": 31,
                  "lastAccessed": 1734060326,
                },
              ],
              "fatHeadwordsLc": [],
              "hiddenHeadwordsLc": [],
              "projectLinks1hop": [],
              "hasBackLinksOrIcons": true,
              "search": "",
              "charsCount": {
                "links1hop": 61,
                "links2hop": 234,
              },
              "searchBackend": "elasticsearch",
            },
            "collaborators": [],
          }),
        );
      },
    );
  });
  await t.step("two projects", async (t) => {
    await t.step("逆・順・双方向External links", async (t) => {
      await assertSnapshot(
        t,
        convert("takker-dist", {
          "id": "63bd16afdb71fb001d058f0e",
          "title": "F",
          "image": null,
          "descriptions": [
            "[/takker-dist2/B]",
            "[/takker-dist2/C]",
            "[/takker-dist2/G]",
            "https://scrapbox.io/api/pages/takker-dist/F",
          ],
          "user": {
            "id": "5ef2bdebb60650001e1280f0",
            "name": "takker",
            "displayName": "takker",
            "photo":
              "https://lh3.googleusercontent.com/a/ACg8ocLv_KexS5Z9P_dx2koMUeJeC4ThWjtwMiEHDizmuY7s3jf4j_c=s96-c",
          },
          "lastUpdateUser": {
            "id": "5ef2bdebb60650001e1280f0",
            "name": "takker",
            "displayName": "takker",
            "photo":
              "https://lh3.googleusercontent.com/a/ACg8ocLv_KexS5Z9P_dx2koMUeJeC4ThWjtwMiEHDizmuY7s3jf4j_c=s96-c",
          },
          "pin": 0,
          "views": 21,
          "linked": 0,
          "commitId": "63bd181661a69e001e7db78e",
          "created": 1673336497,
          "updated": 1673336854,
          "accessed": 1755367424,
          "snapshotCreated": null,
          "snapshotCount": 0,
          "pageRank": 0,
          "lastAccessed": 1673337799,
          "linesCount": 6,
          "charsCount": 95,
          "helpfeels": [],
          "persistent": true,
          "lines": [{
            "id": "63bd16afdb71fb001d058f0e",
            "text": "F",
            "userId": "5ef2bdebb60650001e1280f0",
            "created": 1673336497,
            "updated": 1673336497,
          }, {
            "id": "63bd16b11280f00000b00965",
            "text": "[/takker-dist2/B]",
            "userId": "5ef2bdebb60650001e1280f0",
            "created": 1673336497,
            "updated": 1673336501,
          }, {
            "id": "63bd16b51280f00000b00966",
            "text": "[/takker-dist2/C]",
            "userId": "5ef2bdebb60650001e1280f0",
            "created": 1673336501,
            "updated": 1673336571,
          }, {
            "id": "63bd17041280f00000b0096b",
            "text": "[/takker-dist2/G]",
            "userId": "5ef2bdebb60650001e1280f0",
            "created": 1673336580,
            "updated": 1673336854,
          }, {
            "id": "63bd17111280f00000b0096c",
            "text": "https://scrapbox.io/api/pages/takker-dist/F",
            "userId": "5ef2bdebb60650001e1280f0",
            "created": 1673336594,
            "updated": 1673336640,
          }, {
            "id": "63bd17401280f00000b0096e",
            "text": "",
            "userId": "5ef2bdebb60650001e1280f0",
            "created": 1673336640,
            "updated": 1673336640,
          }],
          "links": [],
          "projectLinks": [
            "/takker-dist2/B",
            "/takker-dist2/C",
            "/takker-dist2/G",
          ],
          "icons": [],
          "files": [],
          "infoboxDefinition": [],
          "infoboxResult": [],
          "infoboxDisableLinks": [],
          "relatedPages": {
            "links1hop": [],
            "links2hop": [],
            "fatHeadwordsLc": [],
            "hiddenHeadwordsLc": [],
            "projectLinks1hop": [{
              "id": "63bd169823cbed001d092543",
              "title": "B",
              "titleLc": "b",
              "image": null,
              "descriptions": ["[B1] [B2]"],
              "linked": 0,
              "created": null,
              "updated": 1673336514,
              "accessed": 1758552749,
              "projectName": "takker-dist2",
            }, {
              "id": "63bd16c41933fc001d0f9dca",
              "title": "C",
              "titleLc": "c",
              "image": null,
              "descriptions": ["[/takker-dist/F]"],
              "linked": 0,
              "created": null,
              "updated": 1673336584,
              "accessed": 1757193206,
              "projectName": "takker-dist2",
            }, {
              "id": "63bd1684ca5336001d6417d9",
              "title": "A",
              "titleLc": "a",
              "image": null,
              "descriptions": ["[/takker-dist/F]"],
              "linked": 0,
              "created": null,
              "updated": 1673336561,
              "accessed": 1704131840,
              "projectName": "takker-dist2",
            }],
            "hasBackLinksOrIcons": false,
            "search": "",
            "charsCount": { "links1hop": 0, "links2hop": 0 },
            "searchBackend": "elasticsearch",
          },
          "collaborators": [],
        }),
      );
    });
  });
});
